import datetime
import mysql.connector
from mysql.connector import Error

from flask import Flask,jsonify,request
from flask_cors import CORS

from db.config import dbconfig

app=Flask(__name__)
# Enable CORS for specific routes
CORS(app, resources={r"/api/*": {
        "origins": "*",
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": True
    }})


# Create a connection pool, so we can reuse connections
cnn_pool = mysql.connector.pooling.MySQLConnectionPool (
    pool_name="mypool",
    pool_size=5, #number of connections in the pool, adjust as needed.
    pool_reset_session=True,
    **dbconfig # unpack the dbconfig dictionary, passing its contents as keyword arguments
)

def get_connection_from_pool():
    try:
        return cnn_pool.get_connection( )
    except Error as e:
        print("Error getting connection from pool:", e)
        return None

# def create_connection():
#     try:
#         # Connect to MySQL
#         connection = mysql.connector.connect(
#             host='localhost',       # or your server IP
#             database=os.getenv('db_name'),  # put your database name here
#             user=os.getenv('db_user'),         # put your MySQL username here   
#             password=os.getenv('db_psw')      # put your MySQL password here
#         )

#         if connection.is_connected():
#             print("Successfully connected to MySQL database 'friendlyguidance'")
            
#             # Optional: create a cursor to execute queries
#             cursor = connection.cursor()
#             cursor.execute("SHOW TABLES;")
#             tables = cursor.fetchall()
#             print("Tables in friendlyguidance:", tables)
#             return connection
#     except Error as e:
#         print("Error while connecting to MySQL", e)


@app.route('/api/queries', methods=['GET'])
def get_queries():
    try:
        connection = get_connection_from_pool()
        if not connection:
            return jsonify({"error": "Unable to connect to database"}), 500 
        
        cursor = connection.cursor(dictionary=True)
        cursor.execute("SELECT * FROM clientquery;")
        rows = cursor.fetchall()
        print("Fetched queries:", rows)
        return jsonify(rows), 200
    except Error as e:
        print("Error fetching queries:", e)
        return jsonify({"error": "Error fetching queries"}), 500
    finally:
        if cursor:
            cursor.close() 
        if connection:
            connection.close() # Return connection to the pool

@app.route('/api/postclient', methods=['POST'])
def post_client():
    try:
        data = request.get_json()
        
        fname = data.get('ClientFName')
        lname = data.get('ClientLName')
        email = data.get('email')
        phone = data.get('mobile')
        query = data.get('query')
        creationdate = datetime.datetime.now()

        connection = get_connection_from_pool()
        if not connection:
            return jsonify({"error": "Unable to connect to database"}), 500 
        

        cursor = connection.cursor()
        insert_client = """
            INSERT INTO clientinfo (clientfname, clientlname, email, mobile)
            VALUES (%s, %s, %s, %s);
        """
        insert_query = """
            INSERT INTO clientquery (email, query, creationdate)
            VALUES (%s, %s, %s);
        """


        cursor.execute(insert_client, (fname, lname, email, phone))
        cursor.execute(insert_query, (email, query, creationdate))

        connection.commit()
        print("Inserted client:", cursor.lastrowid)
        return jsonify({"message": "Client info submitted successfully", "id": cursor.lastrowid}), 201
    except Error as e:
        print("Error inserting client info:", e)
        return jsonify({"error": "Error inserting client info"}), 500
    finally:
        if cursor:
            cursor.close() 
        if connection:
            connection.close() # Return connection to the pool

@app.route('/api/postquery', methods=['POST'])
def post_query():
    try:
        data = request.get_json()
        creationdate = datetime.datetime.now()
        email = data.get('email')
        query_text = data.get('query')

        connection = get_connection_from_pool()
        if not connection:
            return jsonify({"error": "Unable to connect to database"}), 500 
        

        cursor = connection.cursor()
        insert_query = """
            INSERT INTO clientquery (email, query, creationdate)
            VALUES (%s, %s, %s);
        """
        cursor.execute(insert_query, (email, query_text, creationdate))
        connection.commit()
        print("Inserted query:", cursor.lastrowid)
        return jsonify({"message": "Query submitted successfully", "id": cursor.lastrowid}), 201
    except Error as e:
        print("Error inserting query:", e)
        return jsonify({"error": "Error inserting query"}), 500
    finally:
        if cursor:
            cursor.close() 
        if connection:
            connection.close() # Return connection to the pool

if __name__ == '__main__':
    app.run(debug=True)